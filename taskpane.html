<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Otomatik Yanƒ±t Y√∂neticisi</title>

  <!-- Office JS -->
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
  <!-- Fluent UI Core (temel stil) -->
  <link rel="stylesheet"
    href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css">

  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 12px;
      background: #f5f5f5;
      min-height: 100vh;
      box-sizing: border-box
    }

    .container {
      width: 100%;
      max-width: 100%;
      margin: 0;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
      padding: 16px;
      box-sizing: border-box;
      min-height: calc(100vh - 24px)
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #0078d4;
      padding-bottom: 12px
    }

    .header h1 {
      color: #0078d4;
      font-size: 20px;
      margin: 0;
      font-weight: 600
    }

    .form-group {
      margin-bottom: 16px;
      position: relative
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #323130
    }

    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d1d1;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box
    }

    .form-control:focus {
      outline: none;
      border-color: #0078d4;
      box-shadow: 0 0 0 2px rgba(0, 120, 212, .2)
    }

    .date-time-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .date-time-group .form-control {
      flex: 1;
      min-width: 120px
    }

    @media (max-width:350px) {
      .date-time-group {
        flex-direction: column;
        gap: 12px
      }

      .date-time-group .form-control {
        width: 100%
      }
    }

    .btn {
      background: #0078d4;
      color: #fff;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 16px
    }

    .btn:hover {
      background: #106ebe
    }

    .btn:disabled {
      background: #d1d1d1;
      cursor: not-allowed
    }

    .preview-section {
      margin-top: 20px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 4px;
      border-left: 4px solid #0078d4;
      max-height: 220px;
      overflow-y: auto
    }

    .preview-section h3 {
      margin: 0 0 12px 0;
      color: #323130;
      font-size: 16px
    }

    .preview-content {
      font-size: 13px;
      line-height: 1.5;
      color: #605e5c;
      white-space: pre-line
    }

    .status-message {
      padding: 12px;
      border-radius: 4px;
      margin-top: 16px;
      text-align: center;
      font-weight: 600;
      display: none
    }

    .status-success {
      background: #dff6dd;
      color: #107c10;
      border: 1px solid #92c5f7
    }

    .status-error {
      background: #fde7e9;
      color: #d13438;
      border: 1px solid #d13438
    }

    .oof-status-banner {
      background: #fff4e6;
      border: 1px solid #ffb366;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
      color: #cc7a00;
      font-weight: 600;
      text-align: center;
      display: none
    }

    .colleague-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #d1d1d1;
      border-top: none;
      border-radius: 0 0 4px 4px;
      max-height: 240px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
      display: none
    }

    .user-row {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid #f3f2f1
    }

    .user-row:hover {
      background: #f3f2f1
    }

    .dn {
      font-size: 14px
    }

    .em,
    .meta {
      color: #666;
      font-size: 12px
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="oofStatusBanner" class="oof-status-banner">
      <span id="oofStatusText">üìß Otomatik yanƒ±t ≈üu anda aktif</span>
    </div>

    <div class="header">
      <h1>üè¢ Otomatik Yanƒ±t Y√∂neticisi</h1>
    </div>

    <form id="autoReplyForm">
      <div class="form-group">
        <label for="user-search-input">Yetkili Ki≈üi <span style="color:#d13438">*</span></label>
        <input type="text" id="user-search-input" class="form-control" placeholder="Ki≈üi ara..." autocomplete="off"
          required>
        <div id="users-results" class="colleague-dropdown"></div>
        <input type="hidden" id="selected-colleague-id">
      </div>

      <div class="form-group">
        <label for="startDate">Ba≈ülangƒ±√ß Tarihi ve Saati</label>
        <div class="date-time-group">
          <input type="date" id="startDate" class="form-control" required>
          <input type="time" id="startTime" class="form-control" required>
        </div>
      </div>

      <div class="form-group">
        <label for="endDate">Biti≈ü Tarihi ve Saati</label>
        <div class="date-time-group">
          <input type="date" id="endDate" class="form-control" required>
          <input type="time" id="endTime" class="form-control" required>
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <button type="submit" id="btnSetAutoReply" class="btn">Otomatik Yanƒ±tƒ± Ayarla</button>
    </form>

    <div class="preview-section">
      <h3>üìß Mesaj √ñnizleme</h3>
      <div id="messagePreview" class="preview-content">L√ºtfen t√ºm alanlarƒ± doldurun...</div>
      <button id="copyPreviewButton" class="btn" type="button" style="width:auto;margin-top:8px">üìã Kopyala</button>
    </div>

    <div
      style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid #e1dfdd;font-size:12px;color:#605e5c;">
      <span id="versionInfo">S√ºr√ºm: 1.0.10 | Son G√ºncelleme: <span id="lastUpdate"></span></span>
    </div>

    <div id="instructionsModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>üìã Otomatik Yanƒ±t Ayarlama Talimatlarƒ±</h3>
        <div id="instructionsContent"></div>
        <button id="btnModalOk" class="btn" type="button">Anladƒ±m</button>
      </div>
    </div>
  </div>

  <!-- MSAL (NAA) -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@4.22.0/lib/msal-browser.min.js"></script>
  <script>
    /* =======================
       AYARLAR (Admin consent: MailboxSettings.ReadWrite + User.Read.All)
    ======================= */
    const CLIENT_ID = "c2a8b650-50b2-446e-a8e9-bffa6698b77f";
    const TENANT_ID = "26371b5e-948e-4791-a055-003c90306b8c";
    const GRAPH_SCOPES_OOF = ["MailboxSettings.ReadWrite", "openid", "profile"];
    const GRAPH_SCOPES_USERS = ["User.Read.All", "openid", "profile"]; // istek √ºzerine

    const messageTemplate = {
      subject: "Otomatik Yanƒ±t: Yƒ±llƒ±k ƒ∞zin / Automatic Reply: Annual Leave",
      body: `Sayƒ±n Yetkili,

E-postanƒ±z i√ßin te≈üekk√ºr ederim. {startDate} ‚Äì {endDate} tarihleri arasƒ±nda yƒ±llƒ±k izinde olacaƒüƒ±m ve bu s√ºre i√ßinde e-postalarƒ±nƒ±za yanƒ±t veremeyeceƒüim.

{contactLine}

Anlayƒ±≈üƒ±nƒ±z i√ßin te≈üekk√ºr eder, iyi √ßalƒ±≈ümalar dilerim.

Saygƒ±larƒ±mla,
{userName}
{positionLine}
{company}

---

Dear Sir/Madam,

Thank you for your email. I will be out of the office on annual leave from {startDate} to {endDate}, and will not be able to respond to your message during this period.

{contactLineEn}

Thank you for your understanding.

Kind regards,
{userName}
{positionLine}
{company}`
    };

    /* =======================
       GLOBAL DURUM
    ======================= */
    let pca = null;                 // MSAL PCA
    let selectedColleague = null;   // { id, name, email, phone, jobTitle }
    let lastUserResults = [];       // enter ile hƒ±zlƒ± se√ßim i√ßin
    let tokenCache = {};            // scope->token

    /* =======================
          PEOPLE ARAMA
       ======================= */
    const PEOPLE_SCOPES = ["People.Read", "openid", "profile"];

    async function searchPeople(q, top = 25) {
      const token = await getGraphToken(PEOPLE_SCOPES); // senin MSAL/NAA token fonksiyonun
      const url = "https://graph.microsoft.com/v1.0/me/people"
        + `?$search="${q}"`
        + "&$select=displayName,scoredEmailAddresses,mail,userPrincipalName,jobTitle,companyName,phones"
        + `&$top=${top}`;

      const res = await fetch(url, {
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json",
          "ConsistencyLevel": "eventual"   // $search i√ßin ≈üart
        }
      });
      if (!res.ok) throw new Error(`People API ${res.status}: ${await res.text()}`);
      const data = await res.json();

      return (data.value || []).map(p => ({
        id: p.id,
        name: p.displayName,
        email: p.mail || p.userPrincipalName || (p.scoredEmailAddresses?.[0]?.address ?? ""),
        jobTitle: p.jobTitle || "",
        company: p.companyName || "",
        phone: (p.phones && p.phones[0]?.number) || ""
      }));
    }

    /* =======================
          PEOPLE ARAMA SON
       ======================= */

    /* =======================
       YARDIMCI FONK.
    ======================= */
    const $ = id => document.getElementById(id);
    const debounce = (fn, ms = 300) => { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); } };

    function todayISODate() { return new Date().toISOString().split("T")[0]; }
    function formatDisplayDate(dateStr, timeStr) {
      const d = new Date(`${dateStr}T${timeStr}`);
      return d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ` ${timeStr}`;
    }
    function showStatus(type, message) {
      const el = $("statusMessage");
      el.className = `status-message ${type === "success" ? "status-success" : "status-error"}`;
      el.textContent = message;
      el.style.display = "block";
      setTimeout(() => { el.style.display = "none"; }, 8000);
    }
    function setDefaultDates() {
      const sD = $("startDate"), eD = $("endDate"), sT = $("startTime"), eT = $("endTime");
      const today = todayISODate();
      sD.min = eD.min = today;
      sD.value = eD.value = today;      // istek: bug√ºn√ºn tarihi set
      sT.value = "07:30"; eT.value = "17:30";
      sD.addEventListener("change", () => {
        if (eD.value < sD.value) eD.value = sD.value;
        eD.min = sD.value;
        updatePreview();
      });
    }

    /* =======================
       MSAL / TOKEN
    ======================= */
    async function ensurePCA() {
      if (pca) return;
      pca = await msal.createNestablePublicClientApplication({
        auth: { clientId: CLIENT_ID, authority: "https://login.microsoftonline.com/" + TENANT_ID }
      });
      window.pca = pca;
    }
    async function getGraphToken(scopes) {
      await ensurePCA();
      const key = scopes.slice().sort().join(" ");
      if (tokenCache[key]) return tokenCache[key];
      try {
        const r = await pca.acquireTokenSilent({ scopes });
        return tokenCache[key] = r.accessToken;
      } catch {
        const r2 = await pca.acquireTokenPopup({ scopes });
        return tokenCache[key] = r2.accessToken;
      }
    }

    /* =======================
       KULLANICI ARAMA
    ======================= */
    async function graphGET(url, token, extraHeaders = {}) {
      const res = await fetch(url, { headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json", ...extraHeaders } });
      if (!res.ok) throw new Error("Graph " + res.status + ": " + (await res.text()));
      return res.json();
    }

    async function searchUsersPrefix(q, top = 25, select = "displayName,mail,userPrincipalName,jobTitle,mobilePhone,businessPhones,givenName,surname") {
      const token = await getGraphToken(GRAPH_SCOPES_USERS);
      const esc = q.replace(/'/g, "''");
      const filter = `startsWith(displayName,'${esc}') or startsWith(mail,'${esc}') or startsWith(userPrincipalName,'${esc}') or startsWith(givenName,'${esc}') or startsWith(surname,'${esc}')`;
      const url = `https://graph.microsoft.com/v1.0/users?$select=${encodeURIComponent(select)}&$filter=${encodeURIComponent(filter)}&$top=${top}`;
      const data = await graphGET(url, token);
      return (data.value || []).map(u => ({
        id: u.id,
        name: u.displayName || "(adsƒ±z)",
        email: u.mail || u.userPrincipalName || "",
        jobTitle: u.jobTitle || "",
        phone: (u.mobilePhone || (u.businessPhones && u.businessPhones[0])) || ""
      }));
    }

    async function listUsersInitial(top = 30, select = "displayName,mail,userPrincipalName,jobTitle,mobilePhone,businessPhones") {
      const token = await getGraphToken(GRAPH_SCOPES_USERS);
      const url = `https://graph.microsoft.com/v1.0/users?$select=${encodeURIComponent(select)}&$top=${top}`;
      const data = await graphGET(url, token);
      return (data.value || []).map(u => ({
        id: u.id,
        name: u.displayName || "(adsƒ±z)",
        email: u.mail || u.userPrincipalName || "",
        jobTitle: u.jobTitle || "",
        phone: (u.mobilePhone || (u.businessPhones && u.businessPhones[0])) || ""
      }));
    }

    function renderUsers(list) {
      lastUserResults = list.slice();
      const box = $("users-results");
      box.innerHTML = "";
      if (!list.length) { box.style.display = "none"; return; }

      const frag = document.createDocumentFragment();
      list.forEach((u, idx) => {
        const div = document.createElement("div");
        div.className = "user-row";
        div.setAttribute("data-index", idx);
        div.innerHTML = `
          <div class="dn"><strong>${u.name}</strong></div>
          <div class="em">${u.email}</div>
          <div class="meta">${u.jobTitle}${u.jobTitle && u.phone ? ' ¬∑ ' : ''}${u.phone || ''}</div>`;
        div.addEventListener("click", () => selectUser(u));
        frag.appendChild(div);
      });
      box.appendChild(frag);
      box.style.display = "block";
    }

    function selectUser(u) {
      selectedColleague = u;
      $("selected-colleague-id").value = u.id;
      $("user-search-input").value = u.name;
      $("users-results").style.display = "none";
      updatePreview();
    }

    function initUserSearch() {
      const input = $("user-search-input");
      const dropdown = $("users-results");

      input.addEventListener("input", () => {
        // se√ßim zorunluluƒüu: yazƒ±nca sƒ±fƒ±rla
        selectedColleague = null;
        $("selected-colleague-id").value = "";
      });

      const handler = debounce(async () => {
        const q = input.value.trim();
        try {
          if (!q) renderUsers(await searchPeople());
          else renderUsers(await searchUsersPrefix(q, 25));
        } catch (e) { console.error("[users] hata:", e.message || e); }
      }, 300);

      input.addEventListener("focus", handler);
      input.addEventListener("input", handler);

      // Enter ‚Üí listedeki ilk kullanƒ±cƒ±yƒ± se√ß
      input.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") {
          ev.preventDefault();
          if (lastUserResults.length) selectUser(lastUserResults[0]);
        }
      });

      document.addEventListener("click", (e) => {
        if (!dropdown.contains(e.target) && e.target !== input) dropdown.style.display = "none";
      });
    }

    /* =======================
       √ñNƒ∞ZLEME / MESAJ
    ======================= */
    function buildContactLines(col) {
      if (!col) {
        return {
          tr: 'Acil konularƒ±nƒ±z i√ßin l√ºtfen ba≈üka bir yetkiliye ba≈üvurun.',
          en: 'For urgent matters, please contact another authorized person.'
        };
      }
      let tr = 'Acil konularƒ±nƒ±z i√ßin';
      let en = 'For urgent matters, please contact';
      if (col.name) { tr += ` ${col.name} ile`; en += ` ${col.name}`; }
      if (col.email) { tr += ` ${col.email}`; en += ` at ${col.email}`; }
      if (col.phone) { tr += ` veya ${col.phone}`; en += ` or ${col.phone}`; }
      tr += ' √ºzerinden ileti≈üime ge√ßebilirsiniz.'; en += '.';
      return { tr, en };
    }

    async function getUserProfile() {
      try {
        const token = await getGraphToken(["User.Read", "openid", "profile"]);
        const res = await fetch("https://graph.microsoft.com/v1.0/me?$select=displayName,mail,userPrincipalName,jobTitle,companyName", {
          headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
        });
        if (!res.ok) throw new Error("Graph " + res.status);
        const u = await res.json();
        return {
          displayName: u.displayName || '',
          emailAddress: u.mail || u.userPrincipalName || '',
          jobTitle: u.jobTitle || '',
          companyName: u.companyName || '√ñztiryakiler'
        };
      } catch (e) {
        const up = Office?.context?.mailbox?.userProfile || {};
        return {
          displayName: up.displayName || '',
          emailAddress: up.emailAddress || '',
          jobTitle: up.jobTitle || '',
          companyName: '√ñztiryakiler'
        };
      }
    }

    function updatePreview() {
      const preview = $("messagePreview");
      const sD = $("startDate").value, sT = $("startTime").value;
      const eD = $("endDate").value, eT = $("endTime").value;
      if (!selectedColleague || !sD || !sT || !eD || !eT) {
        preview.textContent = "L√ºtfen t√ºm alanlarƒ± doldurun...";
        return;
      }
      const startDisp = formatDisplayDate(sD, sT);
      const endDisp = formatDisplayDate(eD, eT);

      const up = Office?.context?.mailbox?.userProfile || {};
      const positionLine = up.jobTitle || "";
      const company = '√ñztiryakiler';
      const contact = buildContactLines(selectedColleague);

      const body = messageTemplate.body
        .replaceAll('{startDate}', startDisp)
        .replaceAll('{endDate}', endDisp)
        .replaceAll('{contactLine}', contact.tr)
        .replaceAll('{contactLineEn}', contact.en)
        .replaceAll('{userName}', up.displayName || '')
        .replaceAll('{positionLine}', positionLine)
        .replaceAll('{company}', company);

      preview.textContent = `Konu: ${messageTemplate.subject}\n\n${body}`;
    }

    // YERƒ∞NE GE√áSƒ∞N: setOOFWithGraphMessage(...)
    async function setOOFWithGraphMessage(messageBody, sD, sT, eD, eT) {
      let s = new Date(`${sD}T${sT}:00`);
      let e = new Date(`${eD}T${eT}:00`);
      const now = new Date();

      if (e <= s) throw new Error("Biti≈ü tarihi ba≈ülangƒ±√ßtan sonra olmalƒ±.");

      // Ba≈ülangƒ±√ß ge√ßmi≈üteyse Graph 400: InvalidScheduledOofDuration verir ‚Üí en az 1 dk ileri al
      if (s <= now) {
        s = new Date(now.getTime() + 60 * 1000);
        if (e <= s) e = new Date(s.getTime() + 60 * 1000);
      }

      const fmt = d => d.toISOString().slice(0, 19); // yyyy-MM-ddTHH:mm:ss (UTC)
      const token = await getGraphToken(GRAPH_SCOPES_OOF);

      const body = {
        automaticRepliesSetting: {
          status: "scheduled",
          externalAudience: "all",
          scheduledStartDateTime: { dateTime: fmt(s), timeZone: "UTC" },
          scheduledEndDateTime: { dateTime: fmt(e), timeZone: "UTC" },
          internalReplyMessage: messageBody,
          externalReplyMessage: messageBody
        }
      };

      const res = await fetch("https://graph.microsoft.com/v1.0/me/mailboxSettings", {
        method: "PATCH",
        headers: { "Authorization": `Bearer ${token}`, "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(await res.text());
    }


    function bindCopyPreview() {
      $("copyPreviewButton").addEventListener("click", () => {
        const txt = $("messagePreview").textContent || "";
        const ta = document.createElement("textarea");
        ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        const btn = $("copyPreviewButton"); const old = btn.textContent;
        btn.textContent = "‚úÖ Kopyalandƒ±!"; setTimeout(() => btn.textContent = old, 30000);
      });
    }

    // Fetch current OOF status from Graph API
    async function getOofStatus() {
      try {
        const token = await getGraphToken(GRAPH_SCOPES_OOF);
        const res = await fetch("https://graph.microsoft.com/v1.0/me/mailboxSettings/automaticRepliesSetting", {
          headers: { "Authorization": "Bearer " + token, "Content-Type": "application/json" }
        });

        if (!res.ok) {
          console.error("Failed to fetch OOF status:", res.status);
          return null;
        }

        const data = await res.json();
        return data;
      } catch (error) {
        console.error("Error fetching OOF status:", error);
        return null;
      }
    }

    // Show OOF banner with actual status from API
    async function showOofBannerUntil(dateObj) {
      const tz = "Turkey Standard Time";
      const fmtLocal = d => {
        const p = n => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${p(d.getMonth() + 1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds() || 0)}`;
      };

      const b = $("oofStatusBanner"), t = $("oofStatusText");

      // Try to get actual OOF status from API
      const oofSettings = await getOofStatus();

      if (oofSettings && (oofSettings.status === "enabled" || oofSettings.status === "scheduled")) {
        // Use the end date from API if available
        let endDateText = "";
        if (oofSettings.scheduledEndDateTime) {
          const endDate = new Date(oofSettings.scheduledEndDateTime.dateTime);
          console.log('fmtLocal(s):', fmtLocal(endDate));
          // console.log('oofSettings:', fmtLocal(s));
          endDateText = ` (${endDate.toLocaleDateString('tr-TR')} ${endDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} tarihine kadar)`;
        } else if (dateObj) {
          endDateText = ` (${dateObj.toLocaleDateString('tr-TR')} ${dateObj.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })} tarihine kadar)`;
        }

        t.textContent = `üìß Otomatik yanƒ±t ≈üu anda aktif${endDateText}`;
        b.style.display = "block";
      } else {
        // Hide banner if no active OOF
        b.style.display = "none";
      }
    }

    /* =======================
       FORM OLAYLARI
    ======================= */
    async function onSubmit(ev) {
      ev.preventDefault();

      // ZORUNLU: arama sonu√ßlarƒ±ndan se√ßim yapƒ±lmƒ±≈ü olmalƒ±
      if (!selectedColleague || !$("selected-colleague-id").value) {
        $("user-search-input").focus();
        showStatus("error", "L√ºtfen arama yapƒ±p listeden bir ki≈üi se√ßin.");
        return;
      }

      const sD = $("startDate").value, sT = $("startTime").value;
      const eD = $("endDate").value, eT = $("endTime").value;
      if (!sD || !sT || !eD || !eT) {
        showStatus("error", "L√ºtfen t√ºm alanlarƒ± doldurun!");
        return;
      }
      const s = new Date(`${sD}T${sT}`), e = new Date(`${eD}T${eT}`);
      if (s >= e) {
        showStatus("error", "Biti≈ü tarihi ba≈ülangƒ±√ßtan sonra olmalƒ±.");
        return;
      }

      const btn = $("btnSetAutoReply");
      btn.disabled = true; btn.textContent = "Ayarlanƒ±yor...";

      try {
        const user = await getUserProfile();

        const contact = buildContactLines(selectedColleague); // mevcut fonksiyon
        const startDisp = formatDisplayDate(sD, sT);
        const endDisp = formatDisplayDate(eD, eT);
        const positionLine = user.jobTitle || "";

        const messageBodyHtml = `
        <p>Sayƒ±n Yetkili,</p>
        <p>E-postanƒ±z i√ßin te≈üekk√ºr ederim. ${startDisp} ‚Äì ${endDisp} tarihleri arasƒ±nda <strong>yƒ±llƒ±k izindeyim</strong> ve bu s√ºre i√ßinde e-postalarƒ±nƒ±za yanƒ±t veremeyeceƒüim.</p>
        <p>Acil konularƒ±nƒ±z i√ßin <strong>${selectedColleague.name}</strong> ile
          ${selectedColleague.email ? `<a href="mailto:${selectedColleague.email}">${selectedColleague.email}</a>` : ''}
          ${selectedColleague.phone ? ` veya <a href="tel:${selectedColleague.phone.replace(/\s+/g, '')}">${selectedColleague.phone}</a>` : ''} 
          √ºzerinden ileti≈üime ge√ßebilirsiniz.</p>
        <p>Te≈üekk√ºr eder, iyi √ßalƒ±≈ümalar dilerim.</p>
        <p>Saygƒ±larƒ±mla,<br>${user.displayName}<br>${positionLine || ''}<br>${user.companyName || '√ñztiryakiler'}</p>
        <hr>
        <p>Dear Sir/Madam,</p>
        <p>Thank you for your email. I will be  <strong>out of the office</strong> on annual leave from ${startDisp} to ${endDisp} and will not be able to respond to your message during this period.</p>
        <p>For urgent matters, please contact <strong>${selectedColleague.name}</strong>
          ${selectedColleague.email ? ` at <a href="mailto:${selectedColleague.email}">${selectedColleague.email}</a>` : ''}
          ${selectedColleague.phone ? ` or <a href="tel:${selectedColleague.phone.replace(/\s+/g, '')}">${selectedColleague.phone}</a>` : ''}.
        </p>
        <p>Kind regards,<br>${user.displayName}<br>${positionLine || ''}<br>${user.companyName || '√ñztiryakiler'}</p>
        `;

        const body = messageBodyHtml;

        await setOOFWithGraphMessage(body, sD, sT, eD, eT);
        updatePreview();
        showStatus("success", "Otomatik yanƒ±t ba≈üarƒ±yla ayarlandƒ±!");
        showOofBannerUntil(e);
      } catch (err) {
        console.error("OOF hata:", err);
        showStatus("error", "Otomatik yanƒ±t ayarlanƒ±rken hata: " + (err.message || err));
      } finally {
        btn.disabled = false; btn.textContent = "Otomatik Yanƒ±tƒ± Ayarla";
      }
    }

    /* =======================
       INIT
    ======================= */
    Office.onReady(async () => {
      await ensurePCA();
      setDefaultDates();
      initUserSearch();
      bindCopyPreview();
      updatePreview();
      $("lastUpdate").textContent = new Date().toLocaleDateString('tr-TR');
      $("autoReplyForm").addEventListener("submit", onSubmit);
      $("btnModalOk").addEventListener("click", () => { $("instructionsModal").style.display = "none"; });

      // Check and show current OOF status
      await showOofBannerUntil();
    });
  </script>
</body>

</html>