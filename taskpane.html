<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Otomatik Yanƒ±t Y√∂neticisi</title>

  <!-- Office JavaScript API -->
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

  <!-- Fluent UI -->
  <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css">

  <style>
    /* ... mevcut CSS'in aynen kalsƒ±n ... */
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:12px;background:#f5f5f5;min-height:100vh;box-sizing:border-box}
    .container{width:100%;max-width:100%;margin:0;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:16px;box-sizing:border-box;min-height:calc(100vh - 24px)}
    .header{text-align:center;margin-bottom:20px;border-bottom:2px solid #0078d4;padding-bottom:12px}
    .header h1{color:#0078d4;font-size:20px;margin:0;font-weight:600}
    .form-group{margin-bottom:16px;position:relative}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#323130}
    .form-control{width:100%;padding:8px 12px;border:1px solid #d1d1d1;border-radius:4px;font-size:14px;box-sizing:border-box}
    .form-control:focus{outline:none;border-color:#0078d4;box-shadow:0 0 0 2px rgba(0,120,212,.2)}
    .date-time-group{display:flex;gap:8px;flex-wrap:wrap}
    .date-time-group .form-control{flex:1;min-width:120px}
    @media (max-width:350px){.date-time-group{flex-direction:column;gap:12px}.date-time-group .form-control{width:100%}}
    .btn{background:#0078d4;color:#fff;border:none;padding:12px 24px;border-radius:4px;font-size:14px;font-weight:600;cursor:pointer;width:100%;margin-top:16px}
    .btn:hover{background:#106ebe}
    .btn:disabled{background:#d1d1d1;cursor:not-allowed}
    .preview-section{margin-top:20px;padding:12px;background:#f8f9fa;border-radius:4px;border-left:4px solid #0078d4;max-height:200px;overflow-y:auto}
    .preview-section h3{margin:0 0 12px 0;color:#323130;font-size:16px}
    .preview-content{font-size:13px;line-height:1.5;color:#605e5c;white-space:pre-line}
    .oof-status-banner{background:#fff4e6;border:1px solid #ffb366;border-radius:4px;padding:12px;margin-bottom:16px;color:#cc7a00;font-weight:600;text-align:center}
    .colleague-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d1d1;border-top:none;border-radius:0 0 4px 4px;max-height:200px;overflow-y:auto;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,.1);display:none}
    .user-row{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f3f2f1}
    .user-row:hover{background:#f3f2f1}
    .dn{font-size:14px}
    .em,.meta{color:#666;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div id="oofStatusBanner" class="oof-status-banner" style="display:none;">
      <span id="oofStatusText">üìß Otomatik yanƒ±t ≈üu anda aktif</span>
    </div>

    <div class="header"><h1>üè¢ Otomatik Yanƒ±t Y√∂neticisi</h1></div>

    <form id="autoReplyForm">
      <div class="form-group">
        <label for="user-search-input">Yetkili Ki≈üi:</label>
        <input type="text" id="user-search-input" class="form-control" placeholder="Ki≈üi ara..." autocomplete="off">
        <div id="users-results" class="colleague-dropdown"></div>
      </div>

      <div class="form-group">
        <label for="startDate">Ba≈ülangƒ±√ß Tarihi ve Saati:</label>
        <div class="date-time-group">
          <input type="date" id="startDate" class="form-control" required value="2025-09-15">
          <input type="time" id="startTime" class="form-control" required value="07:30">
        </div>
      </div>

      <div class="form-group">
        <label for="endDate">Biti≈ü Tarihi ve Saati:</label>
        <div class="date-time-group">
          <input type="date" id="endDate" class="form-control" required value="2025-09-15">
          <input type="time" id="endTime" class="form-control" required value="17:30">
        </div>
      </div>

      <div id="statusMessage" class="status-message" style="display:none;"></div>

      <!-- SUBMIT DEƒûƒ∞L -->
      <button type="button" id="set-oof-btn" class="btn">Otomatik Yanƒ±tƒ± Ayarla</button>
    </form>

    <div class="preview-section">
      <h3>üìß Mesaj √ñnizleme</h3>
      <div id="messagePreview" class="preview-content">L√ºtfen t√ºm alanlarƒ± doldurun...</div>
      <button id="copyPreviewButton" class="copy-button">üìã Kopyala</button>
    </div>

    <div style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid #e1dfdd;font-size:12px;color:#605e5c;">
      <span id="versionInfo">S√ºr√ºm: 1.0.6 | Son G√ºncelleme: <span id="lastUpdate"></span></span>
    </div>
  </div>

  <!-- MSAL -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@4.22.0/lib/msal-browser.min.js"></script>

  <script>
    /* ==== Sabitler ==== */
    const CLIENT_ID = "c2a8b650-50b2-446e-a8e9-bffa6698b77f";
    const TENANT_ID = "26371b5e-948e-4791-a055-003c90306b8c";
    const USERS_SCOPES = ["User.ReadBasic.All","openid","profile"];

    // --- yardƒ±mcƒ±lar ---
    const debounce = (fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};

    // ==== Kullanƒ±cƒ± Listeleme (Graph) ====
    let pcaInstance=null;

    async function getUsersToken(scopes=USERS_SCOPES){
      if (window.pca) pcaInstance = window.pca;
      if (!pcaInstance){
        pcaInstance = await msal.createNestablePublicClientApplication({
          auth:{ clientId: CLIENT_ID, authority: "https://login.microsoftonline.com/"+TENANT_ID }
        });
      }
      try{
        const r = await pcaInstance.acquireTokenSilent({ scopes });
        return r.accessToken;
      }catch(e){
        throw new Error("Kullanƒ±cƒ± listesi i√ßin consent gerekli veya yetki yok (User.ReadBasic.All).");
      }
    }

    async function graphGET(url, token, extraHeaders={}){
      const res = await fetch(url,{ headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json", ...extraHeaders }});
      if(!res.ok) throw new Error("Graph "+res.status+": "+(await res.text()));
      return res.json();
    }

    async function listAllUsers(max=50, select="displayName,mail,userPrincipalName,jobTitle,department"){
      const token = await getUsersToken();
      let url = `https://graph.microsoft.com/v1.0/users?$select=${encodeURIComponent(select)}&$top=50`;
      const out=[];
      while(url && out.length<max){
        const data = await graphGET(url, token);
        out.push(...(data.value||[]));
        url = data["@odata.nextLink"];
      }
      return out.slice(0,max);
    }

    async function searchUsersPrefix(q, top=25, select="displayName,mail,userPrincipalName,jobTitle,department"){
      const token = await getUsersToken();
      const esc = q.replace(/'/g,"''");
      const filter = `startsWith(displayName,'${esc}') or startsWith(mail,'${esc}') or startsWith(userPrincipalName,'${esc}')`;
      const url = `https://graph.microsoft.com/v1.0/users?$select=${encodeURIComponent(select)}&$filter=${encodeURIComponent(filter)}&$top=${top}`;
      const data = await graphGET(url, token);
      return data.value||[];
    }

    function renderUsers(list){
      const el = document.getElementById("users-results");
      if(!el) return;
      el.innerHTML="";
      if(!list.length){ el.style.display="none"; return; }
      const frag = document.createDocumentFragment();
      list.forEach(u=>{
        const div=document.createElement("div");
        div.className="user-row";
        const dn=u.displayName||"(adsƒ±z)";
        const upn=u.userPrincipalName||"";
        const mail=u.mail||upn;
        const jt=u.jobTitle||"";
        const dep=u.department||"";
        div.innerHTML = `
          <div class="dn"><strong>${dn}</strong></div>
          <div class="em">${mail}</div>
          <div class="meta">${jt}${jt&&dep?' ¬∑ ':''}${dep}</div>`;
        div.addEventListener("click", ()=>{
          const inp=document.getElementById("user-search-input");
          inp.value = dn + " <" + mail + ">";
          el.style.display="none";
        });
        frag.appendChild(div);
      });
      el.appendChild(frag);
      el.style.display="block";
    }

    function initUserSearch(){
      const input=document.getElementById("user-search-input");
      const dropdown=document.getElementById("users-results");
      if(!input || !dropdown) return;

      const handler = debounce(async ()=>{
        const q = input.value.trim();
        try{
          if(!q){ renderUsers(await listAllUsers(50)); }
          else{ renderUsers(await searchUsersPrefix(q,25)); }
        }catch(e){ console.error("[users] hata:", e.message||e); }
      },300);

      input.addEventListener("input", handler);
      document.addEventListener("click", (e)=>{
        if(!dropdown.contains(e.target) && e.target!==input) dropdown.style.display="none";
      });
      handler();
    }

    // ==== OOF (Graph) ====
    let pca; // global
    async function getGraphToken(scopes){
      try{
        const r = await pca.acquireTokenSilent({ scopes });
        return r.accessToken;
      }catch(e){
        // ilk kullanƒ±mda admin consent yoksa bir kez popup gerekebilir (NAA destekler)
        const r2 = await pca.acquireTokenPopup({ scopes });
        return r2.accessToken;
      }
    }

    async function setOOFWithGraph(){
      const scopes = ["MailboxSettings.ReadWrite","openid","profile"];
      const token = await getGraphToken(scopes);

      const body = {
        automaticRepliesSetting:{
          status:"scheduled",
          scheduledStartDateTime:{ dateTime:"2025-09-14T09:00:00.0000000", timeZone:"Turkey Standard Time" },
          scheduledEndDateTime:{   dateTime:"2025-09-22T18:00:00.0000000", timeZone:"Turkey Standard Time" },
          internalReplyMessage:"<p>Ofis dƒ±≈üƒ±ndayƒ±m</p>",
          externalReplyMessage:"<p>Ofis dƒ±≈üƒ±ndayƒ±m</p>"
        }
      };

      const res = await fetch("https://graph.microsoft.com/v1.0/me/mailboxSettings",{
        method:"PATCH",
        headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok){ console.error("Graph hata:", await res.text()); return; }
      console.log("OOF ayarlandƒ± (204)");
    }

    // ==== Office hazƒ±r olunca ====
    Office.onReady(async ()=>{
      // MSAL PCA (tek tane)
      pca = await msal.createNestablePublicClientApplication({
        auth:{ clientId: CLIENT_ID, authority: "https://login.microsoftonline.com/"+TENANT_ID }
      });
      // users tarafƒ± da aynƒ± instance'ƒ± kullansƒ±n
      window.pca = pca;

      // kullanƒ±cƒ± aramasƒ±
      initUserSearch();

      // butona g√ºvenli handler
      const btn = document.getElementById("set-oof-btn");
      btn.addEventListener("click", async (ev)=>{
        ev.preventDefault();
        ev.stopPropagation();
        btn.disabled = true;
        try{ await setOOFWithGraph(); }
        finally{ btn.disabled = false; }
      });

      // kopyala butonu (senin mevcut fonksiyonun yoksa basit bir tane)
      const copyBtn = document.getElementById("copyPreviewButton");
      copyBtn?.addEventListener("click", ()=>{
        const t = document.getElementById("messagePreview")?.innerText || "";
        navigator.clipboard?.writeText(t);
      });
    }); /* <-- BURA √ñNEMLƒ∞: Office.onReady d√ºzg√ºn kapanƒ±yor */
  </script>
</body>
</html>
