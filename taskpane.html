<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Otomatik Yanƒ±t Y√∂neticisi</title>

  <!-- Office JavaScript API -->
  <script src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>

  <!-- Fluent UI Core (sadece temel stiller) -->
  <link rel="stylesheet" href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css">

  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:12px;background:#f5f5f5;min-height:100vh;box-sizing:border-box}
    .container{width:100%;max-width:100%;margin:0;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:16px;box-sizing:border-box;min-height:calc(100vh - 24px)}
    .header{text-align:center;margin-bottom:20px;border-bottom:2px solid #0078d4;padding-bottom:12px}
    .header h1{color:#0078d4;font-size:20px;margin:0;font-weight:600}
    .form-group{margin-bottom:16px;position:relative}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#323130}
    .form-control{width:100%;padding:8px 12px;border:1px solid #d1d1d1;border-radius:4px;font-size:14px;box-sizing:border-box}
    .form-control:focus{outline:none;border-color:#0078d4;box-shadow:0 0 0 2px rgba(0,120,212,.2)}
    .date-time-group{display:flex;gap:8px;flex-wrap:wrap}
    .date-time-group .form-control{flex:1;min-width:120px}
    @media (max-width:350px){.date-time-group{flex-direction:column;gap:12px}.date-time-group .form-control{width:100%}}
    .btn{background:#0078d4;color:#fff;border:none;padding:12px 24px;border-radius:4px;font-size:14px;font-weight:600;cursor:pointer;width:100%;margin-top:16px}
    .btn:hover{background:#106ebe}
    .btn:disabled{background:#d1d1d1;cursor:not-allowed}
    .preview-section{margin-top:20px;padding:12px;background:#f8f9fa;border-radius:4px;border-left:4px solid #0078d4;max-height:220px;overflow-y:auto}
    .preview-section h3{margin:0 0 12px 0;color:#323130;font-size:16px}
    .preview-content{font-size:13px;line-height:1.5;color:#605e5c;white-space:pre-line}
    .status-message{padding:12px;border-radius:4px;margin-top:16px;text-align:center;font-weight:600;display:none}
    .status-success{background:#dff6dd;color:#107c10;border:1px solid #92c5f7}
    .status-error{background:#fde7e9;color:#d13438;border:1px solid #d13438}
    .oof-status-banner{background:#fff4e6;border:1px solid #ffb366;border-radius:4px;padding:12px;margin-bottom:16px;color:#cc7a00;font-weight:600;text-align:center;display:none}
    .colleague-dropdown{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d1d1d1;border-top:none;border-radius:0 0 4px 4px;max-height:240px;overflow-y:auto;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,.1);display:none}
    .user-row{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f3f2f1}
    .user-row:hover{background:#f3f2f1}
    .dn{font-size:14px}
    .em,.meta{color:#666;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <div id="oofStatusBanner" class="oof-status-banner">
      <span id="oofStatusText">üìß Otomatik yanƒ±t ≈üu anda aktif</span>
    </div>

    <div class="header"><h1>üè¢ Otomatik Yanƒ±t Y√∂neticisi</h1></div>

    <form id="autoReplyForm">
      <div class="form-group">
        <label for="user-search-input">Yetkili Ki≈üi <span style="color:#d13438">*</span></label>
        <input type="text" id="user-search-input" class="form-control" placeholder="Ki≈üi ara..." autocomplete="off" required>
        <div id="users-results" class="colleague-dropdown"></div>
        <input type="hidden" id="selected-colleague-id">
      </div>

      <div class="form-group">
        <label for="startDate">Ba≈ülangƒ±√ß Tarihi ve Saati</label>
        <div class="date-time-group">
          <input type="date" id="startDate" class="form-control" required>
          <input type="time" id="startTime" class="form-control" required>
        </div>
      </div>

      <div class="form-group">
        <label for="endDate">Biti≈ü Tarihi ve Saati</label>
        <div class="date-time-group">
          <input type="date" id="endDate" class="form-control" required>
          <input type="time" id="endTime" class="form-control" required>
        </div>
      </div>

      <div id="statusMessage" class="status-message"></div>

      <button type="submit" id="btnSetAutoReply" class="btn">Otomatik Yanƒ±tƒ± Ayarla</button>
    </form>

    <div class="preview-section">
      <h3>üìß Mesaj √ñnizleme</h3>
      <div id="messagePreview" class="preview-content">L√ºtfen t√ºm alanlarƒ± doldurun...</div>
      <button id="copyPreviewButton" class="btn" style="width:auto;margin-top:8px">üìã Kopyala</button>
    </div>

    <div style="text-align:center;margin-top:20px;padding-top:16px;border-top:1px solid #e1dfdd;font-size:12px;color:#605e5c;">
      <span id="versionInfo">S√ºr√ºm: 1.0.10 | Son G√ºncelleme: <span id="lastUpdate"></span></span>
    </div>

    <div id="instructionsModal" class="modal" style="display:none;">
      <div class="modal-content">
        <h3>üìã Otomatik Yanƒ±t Ayarlama Talimatlarƒ±</h3>
        <div id="instructionsContent"></div>
        <button id="btnModalOk" class="btn" type="button">Anladƒ±m</button>
      </div>
    </div>
  </div>

  <!-- MSAL (NAA) -->
  <script src="https://cdn.jsdelivr.net/npm/@azure/msal-browser@4.22.0/lib/msal-browser.min.js"></script>

  <script>
    /* =======================
       AYARLAR
    ======================= */
    const CLIENT_ID = "c2a8b650-50b2-446e-a8e9-bffa6698b77f";
    const TENANT_ID = "26371b5e-948e-4791-a055-003c90306b8c";
    const GRAPH_SCOPES_OOF   = ["MailboxSettings.ReadWrite","openid","profile"];
    const GRAPH_SCOPES_USERS = ["User.Read","People.Read","openid","profile"];

    // ≈ûablon (senin verdiƒüin metin)
    const messageTemplate = {
      subject: "Otomatik Yanƒ±t: Yƒ±llƒ±k ƒ∞zin / Automatic Reply: Annual Leave",
      body: `Sayƒ±n Yetkili,

E-postanƒ±z i√ßin te≈üekk√ºr ederim. {startDate} ‚Äì {endDate} tarihleri arasƒ±nda yƒ±llƒ±k izinde olacaƒüƒ±m ve bu s√ºre i√ßinde e-postalarƒ±nƒ±za yanƒ±t veremeyeceƒüim.

{contactLine}

Anlayƒ±≈üƒ±nƒ±z i√ßin te≈üekk√ºr eder, iyi √ßalƒ±≈ümalar dilerim.

Saygƒ±larƒ±mla,
{userName}
{positionLine}
{company}

---

Dear Sir/Madam,

Thank you for your email. I will be out of the office on annual leave from {startDate} to {endDate}, and will not be able to respond to your message during this period.

{contactLineEn}

Thank you for your understanding.

Kind regards,
{userName}
{positionLine}
{company}`
    };

    /* =======================
       GLOBAL DURUM
    ======================= */
    let pca = null;                 // MSAL PCA (NAA)
    let selectedColleague = null;   // { id, name, email, phone, jobTitle }
    let tokenCache = {};            // scope->token k√º√ß√ºk cache

    /* =======================
       YARDIMCILAR
    ======================= */
    const $ = id => document.getElementById(id);
    const debounce = (fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};

    const todayISODate = () => new Date().toISOString().split("T")[0];
    const pad = n => String(n).padStart(2,"0");

    function formatDisplayDate(dateStr, timeStr){
      const d = new Date(`${dateStr}T${timeStr}`);
      return d.toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'numeric'})+` ${timeStr}`;
    }

    function showStatus(type, message){
      const el = $("statusMessage");
      el.className = `status-message ${type==="success"?"status-success":"status-error"}`;
      el.textContent = message;
      el.style.display = "block";
      setTimeout(()=>{ el.style.display="none"; }, 8000);
    }

    function setDefaultDates(){
      const startD = $("startDate"), endD = $("endDate");
      const startT = $("startTime"), endT = $("endTime");
      const today = todayISODate();
      startD.min = endD.min = today;
      startD.value = today;
      endD.value = today; // ƒ∞stek: ‚Äútarih kƒ±sƒ±mlarƒ±nda g√ºn√ºn tarihi set edilsin‚Äù
      // makul varsayƒ±lan saatler
      startT.value = "09:00";
      endT.value   = "18:00";

      startD.addEventListener("change", ()=>{
        if (endD.value < startD.value) endD.value = startD.value;
        endD.min = startD.value;
        updatePreview();
      });
    }

    /* =======================
       MSAL / TOKEN
    ======================= */
    async function ensurePCA(){
      if (pca) return;
      pca = await msal.createNestablePublicClientApplication({
        auth:{ clientId: CLIENT_ID, authority: "https://login.microsoftonline.com/"+TENANT_ID }
      });
      window.pca = pca; // users tarafƒ± da aynƒ±sƒ±nƒ± kullansƒ±n
    }

    async function getGraphToken(scopes){
      await ensurePCA();
      const key = scopes.sort().join(" ");
      if (tokenCache[key]) return tokenCache[key];
      try{
        const r = await pca.acquireTokenSilent({ scopes });
        tokenCache[key] = r.accessToken;
        return r.accessToken;
      }catch{
        const r2 = await pca.acquireTokenPopup({ scopes });
        tokenCache[key] = r2.accessToken;
        return r2.accessToken;
      }
    }

    /* =======================
       KULLANICI ARAMA
    ======================= */
    async function graphGET(url, token, extraHeaders={}){
      const res = await fetch(url,{ headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json", ...extraHeaders }});
      if (!res.ok) throw new Error("Graph "+res.status+": "+(await res.text()));
      return res.json();
    }

    async function searchUsersPrefix(q, top=25, select="displayName,mail,userPrincipalName,jobTitle,mobilePhone,businessPhones"){
      const token = await getGraphToken(GRAPH_SCOPES_USERS);
      const esc = q.replace(/'/g,"''");
      const filter = `startsWith(displayName,'${esc}') or startsWith(mail,'${esc}') or startsWith(userPrincipalName,'${esc}')`;
      const url = `https://graph.microsoft.com/v1.0/users?$select=${encodeURIComponent(select)}&$filter=${encodeURIComponent(filter)}&$top=${top}`;
      const data = await graphGET(url, token);
      return (data.value||[]).map(u=>({
        id: u.id,
        name: u.displayName || "(adsƒ±z)",
        email: u.mail || u.userPrincipalName || "",
        jobTitle: u.jobTitle || "",
        phone: (u.mobilePhone || (u.businessPhones && u.businessPhones[0])) || ""
      }));
    }

    async function listUsersInitial(top=30, select="displayName,mail,userPrincipalName,jobTitle,mobilePhone,businessPhones"){
      const token = await getGraphToken(GRAPH_SCOPES_USERS);
      const url = `https://graph.microsoft.com/v1.0/users?$select=${encodeURIComponent(select)}&$top=${top}`;
      const data = await graphGET(url, token);
      return (data.value||[]).map(u=>({
        id: u.id,
        name: u.displayName || "(adsƒ±z)",
        email: u.mail || u.userPrincipalName || "",
        jobTitle: u.jobTitle || "",
        phone: (u.mobilePhone || (u.businessPhones && u.businessPhones[0])) || ""
      }));
    }

    function renderUsers(list){
      const box = $("users-results");
      box.innerHTML = "";
      if (!list.length){ box.style.display="none"; return; }

      const frag = document.createDocumentFragment();
      list.forEach(u=>{
        const div = document.createElement("div");
        div.className = "user-row";
        div.innerHTML = `
          <div class="dn"><strong>${u.name}</strong></div>
          <div class="em">${u.email}</div>
          <div class="meta">${u.jobTitle}${u.jobTitle && u.phone?' ¬∑ ':''}${u.phone||''}</div>`;
        div.addEventListener("click", ()=>{
          selectedColleague = u;
          $("selected-colleague-id").value = u.id;
          $("user-search-input").value = u.name; // serbest yazmayƒ± engellemiyoruz ama kontrol ediyoruz
          box.style.display="none";
          updatePreview();
        });
        frag.appendChild(div);
      });
      box.appendChild(frag);
      box.style.display="block";
    }

    function initUserSearch(){
      const input = $("user-search-input");
      const dropdown = $("users-results");

      // yazƒ± deƒüi≈üirse se√ßimi iptal et ‚Üí liste se√ßimi ZORUNLU
      input.addEventListener("input", ()=>{
        selectedColleague = null;
        $("selected-colleague-id").value = "";
      });

      const handler = debounce(async ()=>{
        const q = input.value.trim();
        try{
          if (!q) renderUsers(await listUsersInitial());
          else    renderUsers(await searchUsersPrefix(q,25));
        }catch(e){ console.error("[users] hata:", e.message||e); }
      }, 300);

      input.addEventListener("focus", handler);
      input.addEventListener("input", handler);

      document.addEventListener("click", (e)=>{
        if (!dropdown.contains(e.target) && e.target!==input) dropdown.style.display="none";
      });
    }

    /* =======================
       OOF DURUM / MESAJ OLU≈ûTURMA
    ======================= */
    function buildContactLines(col){
      if (!col) {
        return {
          tr: 'Acil konularƒ±nƒ±z i√ßin l√ºtfen ba≈üka bir yetkiliye ba≈üvurun.',
          en: 'For urgent matters, please contact another authorized person.'
        };
      }
      let tr = 'Acil konularƒ±nƒ±z i√ßin';
      let en = 'For urgent matters, please contact';
      if (col.name){ tr += ` ${col.name} ile`; en += ` ${col.name}`; }
      if (col.email){ tr += ` ${col.email}`;    en += ` at ${col.email}`; }
      if (col.phone){ tr += ` veya ${col.phone}`; en += ` or ${col.phone}`; }
      tr += ' √ºzerinden ileti≈üime ge√ßebilirsiniz.'; en += '.';
      return { tr, en };
    }

    async function getUserProfile(){
      try{
        const token = await getGraphToken(["User.Read","openid","profile"]);
        const res = await fetch("https://graph.microsoft.com/v1.0/me?$select=displayName,mail,userPrincipalName,jobTitle,companyName",{
          headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json" }
        });
        if (!res.ok) throw new Error("Graph "+res.status);
        const u = await res.json();
        return {
          displayName: u.displayName || 'Kullanƒ±cƒ±',
          emailAddress: u.mail || u.userPrincipalName || '',
          jobTitle: u.jobTitle || '',
          companyName: u.companyName || '√ñztiryakiler'
        };
      }catch(e){
        // Office context fallback
        const up = Office?.context?.mailbox?.userProfile || {};
        return {
          displayName: up.displayName || 'Kullanƒ±cƒ±',
          emailAddress: up.emailAddress || '',
          jobTitle: up.jobTitle || '',
          companyName: '√ñztiryakiler'
        };
      }
    }

    function updatePreview(){
      const preview = $("messagePreview");
      const startDate = $("startDate").value;
      const startTime = $("startTime").value;
      const endDate   = $("endDate").value;
      const endTime   = $("endTime").value;

      if (!selectedColleague || !startDate || !startTime || !endDate || !endTime){
        preview.textContent = "L√ºtfen t√ºm alanlarƒ± doldurun...";
        return;
      }

      const startDisp = formatDisplayDate(startDate, startTime);
      const endDisp   = formatDisplayDate(endDate,   endTime);

      // kullanƒ±cƒ± bilgisi asenkron, √∂nizlemeyi bloklamayalƒ±m: basit bir isimle doldur, submit'te kesinle≈ütiriyoruz
      const up = Office?.context?.mailbox?.userProfile || {};
      const positionLine = up.jobTitle || "";
      const company = '√ñztiryakiler';
      const contact = buildContactLines(selectedColleague);

      const body = messageTemplate.body
        .replaceAll('{startDate}', startDisp)
        .replaceAll('{endDate}',   endDisp)
        .replaceAll('{contactLine}',   contact.tr)
        .replaceAll('{contactLineEn}', contact.en)
        .replaceAll('{userName}',  up.displayName || 'Kullanƒ±cƒ±')
        .replaceAll('{positionLine}', positionLine)
        .replaceAll('{company}', company);

      preview.textContent = `Konu: ${messageTemplate.subject}\n\n${body}`;
    }

    async function setOOFWithGraphMessage(messageBody, startDate, startTime, endDate, endTime){
      const startLocal = `${startDate}T${startTime}:00`;
      const endLocal   = `${endDate}T${endTime}:00`;

      const token = await getGraphToken(GRAPH_SCOPES_OOF);
      const body = {
        automaticRepliesSetting:{
          status:"scheduled",
          externalAudience:"all",
          scheduledStartDateTime:{ dateTime: startLocal, timeZone:"Turkey Standard Time" },
          scheduledEndDateTime:{   dateTime: endLocal,   timeZone:"Turkey Standard Time" },
          internalReplyMessage: messageBody,
          externalReplyMessage: messageBody
        }
      };
      const res = await fetch("https://graph.microsoft.com/v1.0/me/mailboxSettings",{
        method:"PATCH",
        headers:{ "Authorization":"Bearer "+token, "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if (!res.ok) throw new Error(await res.text());
    }

    function bindCopyPreview(){
      $("copyPreviewButton").addEventListener("click", ()=>{
        const txt = $("messagePreview").textContent || "";
        const ta = document.createElement("textarea");
        ta.value = txt; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
        const btn = $("copyPreviewButton"); const old = btn.textContent;
        btn.textContent = "‚úÖ Kopyalandƒ±!"; setTimeout(()=>btn.textContent=old, 30000);
      });
    }

    function showOofBannerUntil(dateObj){
      const b = $("oofStatusBanner"), t=$("oofStatusText");
      const d = dateObj.toLocaleDateString('tr-TR');
      t.textContent = `üìß Otomatik yanƒ±t ≈üu anda aktif (${d} tarihine kadar)`;
      b.style.display = "block";
    }

    /* =======================
       FORM OLAYLARI
    ======================= */
    async function onSubmit(ev){
      ev.preventDefault();

      // ZORUNLULUK: listeden se√ßim
      if (!selectedColleague || !$("selected-colleague-id").value){
        $("user-search-input").focus();
        showStatus("error","L√ºtfen listeden bir ki≈üi se√ßin.");
        return;
      }

      const startDate = $("startDate").value;
      const startTime = $("startTime").value;
      const endDate   = $("endDate").value;
      const endTime   = $("endTime").value;

      if (!startDate || !startTime || !endDate || !endTime){
        showStatus("error","L√ºtfen t√ºm alanlarƒ± doldurun!");
        return;
      }
      const s = new Date(`${startDate}T${startTime}`);
      const e = new Date(`${endDate}T${endTime}`);
      if (s >= e){
        showStatus("error","Biti≈ü tarihi ba≈ülangƒ±√ßtan sonra olmalƒ±.");
        return;
      }

      const btn = $("btnSetAutoReply");
      btn.disabled = true; btn.textContent = "Ayarlanƒ±yor...";

      try{
        const user = await getUserProfile();
        const contact = buildContactLines(selectedColleague);
        const startDisp = formatDisplayDate(startDate,startTime);
        const endDisp   = formatDisplayDate(endDate,endTime);
        const positionLine = user.jobTitle || "";
        const body = messageTemplate.body
          .replaceAll('{startDate}', startDisp)
          .replaceAll('{endDate}',   endDisp)
          .replaceAll('{contactLine}',   contact.tr)
          .replaceAll('{contactLineEn}', contact.en)
          .replaceAll('{userName}',  user.displayName || 'Kullanƒ±cƒ±')
          .replaceAll('{positionLine}', positionLine)
          .replaceAll('{company}',   user.companyName || '√ñztiryakiler');

        // OOF SET
        await setOOFWithGraphMessage(body, startDate, startTime, endDate, endTime);

        // √ñnizlemeyi g√ºncelle ve banner g√∂ster
        updatePreview();
        showStatus("success","Otomatik yanƒ±t Graph API ile ba≈üarƒ±yla ayarlandƒ±!");
        showOofBannerUntil(e);
      }catch(err){
        console.error("OOF hata:", err);
        showStatus("error","Otomatik yanƒ±t ayarlanƒ±rken hata: " + (err.message||err));
      }finally{
        btn.disabled = false; btn.textContent = "Otomatik Yanƒ±tƒ± Ayarla";
      }
    }

    /* =======================
       INIT
    ======================= */
    Office.onReady(async (info)=>{
      // MSAL hazƒ±rla
      await ensurePCA();

      // varsayƒ±lan tarih/saatler = bug√ºn
      setDefaultDates();

      // kullanƒ±cƒ± aramasƒ±
      initUserSearch();

      // √∂nizleme ve kopyala
      bindCopyPreview();
      updatePreview();

      // s√ºr√ºm/son g√ºncelleme
      $("lastUpdate").textContent = new Date().toLocaleDateString('tr-TR');

      // form submit
      $("autoReplyForm").addEventListener("submit", onSubmit);

      // modal kapat
      $("btnModalOk").addEventListener("click", ()=>{$("instructionsModal").style.display="none";});
    });
  </script>
</body>
</html>
